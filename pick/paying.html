<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
    <title>付款</title><!--jquery-->

    <script src="https://code.jquery.com/jquery-3.4.1.min.js">
    </script><!--bootstrap-->

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js">
    </script><!--時間處理插件-->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.min.js">
    </script>
    <script>
        var intervals = [];
        document.addEventListener('DOMContentLoaded', timer);

        var list = [];
        var paidList = [];

        function timer() {
            intervals.push(setInterval(getDOM, 1000));
        }

        var title = '';
        var search = '';
        var message = '';
        var input = '';
        var order = '';
        var result = '';
        var total = '';
        var paid = '';
        var checkout = '';
        var change = '';
        var sumbit = '';
        var resetBtn = '';

        function getDOM() {
            for (var i = 0; i < intervals.length; i++) {
                clearInterval(intervals[i]);
                delete intervals[i];
            }
            intervals = [];
            list = [];
            paidList = [];
            title = document.querySelector('#title');
            search = document.querySelector('#search');
            message = document.querySelector('#message');
            countText = document.querySelector('#countText');
            result = document.querySelector('#result');
            total = document.querySelector('#total');
            paid = document.querySelector('#paid');
            change = document.querySelector('#change');
            searchBtn = document.querySelector('#searchBtn');
            checkoutBtn = document.querySelector('#checkout');
            sumbitBtn = document.querySelector('#sumbit');
            resetBtn = document.querySelector('#resetBtn');
            getList();
            return;
        }
        function getList() {
            var dataset = '1ojvqvFjQff-GZbWbw10NkMhUofqDM7evGuWhgpAysns';
            var datasetNumber = '1';
            $.get("https://spreadsheets.google.com/feeds/list/" + dataset + "/" + datasetNumber + "/public/values?alt=json")
            .then(function(data) { readData(data); })
            .then(main);
            return;
        }
        function readData(data) {
            var d = data.feed.entry;
            for (var i = 1; i < d.length; i++) {
                var status = parseInt(d[i].gsx$status.$t);
                var id = d[i].gsx$id.$t;
                if (status != 0) {
                    paidList.push(id);
                    continue;
                }
                var no = parseInt(d[i].gsx$no.$t);
                var index = d[i].gsx$index.$t;
                var name = d[i].gsx$name.$t;
                //var hiddenname = d[i].gsx$hiddenname.$t;
                //var dept = d[i].gsx$dept.$t;
                //var deptname = d[i].gsx$deptname.$t;
                //var grade = parseInt(d[i].gsx$grade.$t);
                var deptgrade = d[i].gsx$deptgrade.$t;
                var phoneno = d[i].gsx$phoneno.$t;
                var email = d[i].gsx$email.$t;
                var pickday = new Date(d[i].gsx$pickday.$t.split(' ')[0].replace(/-/g, '/'));
                var coupon = d[i].gsx$coupon.$t;
                var total = parseInt(d[i].gsx$total.$t);
                //var dis = parseInt(d[i].gsx$dis.$t);
                //var mdis = parseInt(d[i].gsx$mdis.$t);
                //var cost = parseInt(d[i].gsx$cost.$t);
                var mem = (d[i].gsx$mem.$t == '是' ? true : false);
                var pri = (d[i].gsx$pri.$t == '是' ? true : false);
                var order = parseOrder();
                function parseOrder() {
                    //console.log(no, d[i].gsx$order.$t)
                    var obj = JSON.parse(d[i].gsx$order.$t);
                    delete obj.outputText;
                    return obj;
                };
                list.push({
                    'status': status,
                    'no': no,
                    'index': index,
                    'name': name,
                    /*'hiddenname': hiddenname,*/
                    'id': id,
                    /*'dept': dept,
                    'deptname': deptname,
                    'grade': grade,*/
                    'deptgrade': deptgrade,
                    'phoneno': phoneno,
                    'email': email,
                    'pickday': pickday,
                    'coupon': coupon,
                    'total': total,
                    /*'dis': dis,
                    'mdis': mdis,
                    'cost': cost,*/
                    'mem': mem,
                    'pri': pri,
                    'order': order
                });
            }
            return;
        }

        function main() {
            var orders = [];
            var stdID = 0;
            var noList = [];

            search.disabled = '';
            searchBtn.disabled = '';
            $(search).focus();

            search.addEventListener('input', function(e){
                result.innerHTML = '';
                var v = this.value;
                parseResult(this, v);
                if (orders.length > 0) {
                    stdID = v;
                } else {
                    stdID = '';
                    for (var i = 0; i < paidList.length; i++) {
                        if (v == paidList[i]) {
                            result.innerHTML = '已付款！';
                        }
                    }
                }
                total.value = '';
                paid.value = '';
                change.value = '';
            });

            searchBtn.addEventListener('click', searchBtnListener);
            checkoutBtn.addEventListener('click', checkoutBtnListener);
            sumbitBtn.addEventListener('click', submitListener);
            resetBtn.addEventListener('click', resetBtnListener);
            search.addEventListener('keydown', searchListener);
            paid.addEventListener('keydown', paidListener);

            function searchBtnListener(e){
                entered(this);
                $(paid).trigger('focus');
            }

            function checkoutBtnListener(e){
                checkout();
            }

            function resetBtnListener(e){
                reset();
                $(search).trigger('focus');
            }

            function searchListener(e){
                if (e.code == 'Enter' || e.code == 'NumpadEnter') {
                $(searchBtn).trigger('click');
                }
            }

            function paidListener(e){
                if (e.code == 'Enter' || e.code == 'NumpadEnter') {
                    $(checkoutBtn).trigger('click');
                }
            }

            function submitListener(e){
                searchBtn.removeEventListener('click', searchBtnListener);
                checkoutBtn.removeEventListener('click', checkoutBtnListener);
                sumbitBtn.removeEventListener('click', submitListener);
                resetBtn.removeEventListener('click', resetBtnListener);
                search.removeEventListener('keydown', searchListener);
                paid.removeEventListener('keydown', paidListener);
                sumbit();
            }

            function entered(item) {
                if (orders.length <= 0) {
                    result.innerHTML = '輸入無效！';
                    return;
                }
                for (var i = 0; i < document.querySelectorAll('[name="orderCheck"]').length; i++) {
                    document.querySelectorAll('[name="orderCheck"]')[i].disabled = 'disabled';
                }
                parseResult(item, search.value);
                var orderCheckItemList = document.querySelectorAll('input[name="orderCheck"]');
                var orderCheckItemValueList = [];
                for (var i = 0; i < orderCheckItemList.length; i++) {
                    if (orderCheckItemList[i].checked === false) {
                        noList.splice(noList.indexOf(orderCheckItemList[i]), 1);
                        //orders.splice(noList.indexOf(orderCheckItemList[i]), 1);
                    } else {
                        orderCheckItemValueList.push(parseInt(orderCheckItemList[i].value))
                    }
                }
                for (var i = 0; i < orders.length; i++) {
                    if (orderCheckItemValueList.indexOf(orders[i].no) == -1) {
                        delete orders[i];
                    }
                }
                for (var i = 0; i < orders.length; i++) {
                    if (orders[i] ==  null) {
                      orders.splice(i, 1);
                      i--;
                    }
                }
                var gt = 0;
                if (orders.length > 0) {
                    for (var i = 0; i < orders.length; i++) {
                        gt += orders[i].total;
                    }
                }
                total.value = gt;
                search.disabled = 'disabled';
                searchBtn.disabled = 'disabled';
                paid.disabled = '';
                resetBtn.disabled = '';
                checkoutBtn.disabled = '';
                s = 0;
            }

            function checkout() {
                var c = paid.value - total.value;
                if (c >= 0 || (c == 0 && total.value == 0)) {
                    change.value = c;
                    checkoutBtn.disabled = 'disabled';
                    paid.disabled = 'disabled';
                    sumbitBtn.disabled = '';
                } else {
                    sumbitBtn.disabled = 'disabled';
                    change.value = '金額不足';
                }
            }

            function sumbit() {
                var orderCheckItemList = document.querySelectorAll('#c[checked]');
                for (var i = 0; i < orderCheckItemList.length; i++) {
                    if (orderCheckItemList[i].checked === false) {
                        noList.splice(noList.indexOf(orderCheckItemList[i]), 1);
                    }
                }

                checkoutBtn.disabled = 'disabled';
                resetBtn.disabled = 'disabled';
                sumbitBtn.disabled = 'disabled';

                var timestamp = moment().format('YYYY-MM-DD HH:mm:ss');
                var totalv = total.value;
                var paidv = paid.value;
                var changev = (change.value * -1);

                writePaid(stdID, totalv, paidv, changev);

                for (var i = 0; i < noList.length; i++) {
                    writeEndPay(noList[i]);
                }

                for (var i = 0; i < noList.length; i++) {
                    writeStartPick(noList[i]);
                }

                countText.innerHTML = '0';
                result.innerHTML = '';
                search.value = '';
                total.value = '';
                paid.value = '';
                change.value = '';
                search.disabled = '';

                function writePaid(stdID, totalv, paidv, changev) {
                    $.ajax({
                        type: 'post',
                        data: {
                            'method': 'write',
                            'timestamp': timestamp,
                            'stdID': stdID,
                            'total': totalv,
                            'paid': paidv,
                            'change': changev,
                            'status': 1
                        },
                        url: 'https://script.google.com/macros/s/AKfycbxYxcllkBbQzSb5D1Ci1kxp3o41ynQdCkoJFvo9XOsxgntfscU/exec',
                        success: function(e) {
                            alert(e);
                        }
                    });
                }
                function writeEndPay(no) {
                    $.ajax({
                        type: 'post',
                        data: {
                            'method': 'write',
                            'no': no,
                            'status': 1,
                            'timestamp': timestamp
                        },
                        url: 'https://script.google.com/macros/s/AKfycbyIEpRl3r5iuV55-NnhOH6vB9iU6_xd2EVe9A4EdBt0ikZzfIM/exec',
                        success: function(e) {
                            alert(e);
                        }
                    });
                }
                function writeStartPick(no) {
                    $.ajax({
                        type: 'post',
                        data: {
                            'method': 'paid',
                            'no': no,
                            'status': 1,
                            'timestamp': timestamp
                        },
                        url: 'https://script.google.com/macros/s/AKfycbz3bV4zad3hJQ24DOtoYz_lG5QcaSfWsWXeTMVwdJiKUWNGwtSK/exec',
                        success: function(e) {
                            alert(e);
                        }
                    });
                }

                timer();
                return;
            }

            function parseResult(item, v) {
                //console.table(list);
                orders = [];
                noList = [];
                for (var i = 0; i < list.length; i++) {
                    if (list[i].id == v) {
                        orders.push(list[i]);
                        noList.push(list[i].no);
                    }
                }
                resultToDOM(orders, (item.id == 'searchBtn' ? 'entered' : 'inputting'));
                if (v != '') {
                    countText.innerHTML = orders.length;
                }
                return orders;
            }

            function reset() {
                search.value = '';
                total.value = '';
                paid.value = '';
                change.value = '';
                search.disabled = '';
                searchBtn.disabled = '';
                paid.disabled = 'disabled';
                resetBtn.disabled = 'disabled';
                checkoutBtn.disabled = 'disabled';
                sumbitBtn.disabled = 'disabled';
                countText.innerHTML = '0';
                result.innerHTML = '';
            }

            function resultToDOM(orders, method) {
                var fragment = result;
                //console.log(orders);
                for (var i = 0; i < orders.length; i++) {
                    var div = '';
                    var no =  orders[i].no;
                    var name = orders[i].name;
                    var id = orders[i].id;
                    var deptgrade = orders[i].deptgrade;
                    var pickday = moment(orders[i].pickday).format('M[ 月 ]DD[ 日]');
                    var coupon = orders[i].coupon;
                    var dayValue = parseInt(moment(orders[i].pickday).format('D'));
                    //var nowValue = parseInt(moment().format('D'));
                    var nowValue = 13;
                    if (method == 'inputting') {
                        console.log(dayValue)
                        console.log(nowValue)
                        console.log(dayValue >= nowValue)
                        div = document.createElement('div');
                        div.id = 'no-' + no;
                        div.className = 'col mb-2';
                        div.innerHTML += '<div class="input-group mb-2">'
                            + '<div class="input-group-prepend">'
                                + '<div class="input-group-text"><input type="checkbox" name="orderCheck" ' + (dayValue >= nowValue ? 'checked' : '') +' value="' + no + '" id="c"><\/div>'
                            + '<\/div>'
                            + '<div class="input-group-append">'
                                + '<span class="input-group-text" id="n">' + name + '<\/span>'
                                + '<span class="input-group-text" id="i">' + id + '<\/span>'
                                + '<span class="input-group-text" id="d">' + deptgrade + '<\/span>'
                                + '<span class="input-group-text" id="p">' + pickday + '<\/span>'
                                + '<span class="input-group-text" id="p">' + '折扣碼➡' + '<\/span>'
                                + '<span class="input-group-text" id="p">' + coupon + '<\/span>'
                            + '<\/div>'
                        + '<\/div>';
                        fragment.appendChild(div);
                    }
                    if (method == 'entered') {
                        div = document.querySelector('#no-' + no);
                        div.querySelector('#c').value = no;
                        div.querySelector('#n').innerHTML = name;
                        div.querySelector('#i').innerHTML = id;
                        div.querySelector('#d').innerHTML = deptgrade;
                        div.querySelector('#p').innerHTML = pickday;
                        var order = orders[i].order;
                        var orderTable = document.createElement('table');
                            orderTable.className = 'mb-2';
                        var orderTbody = document.createElement('tbody');
                        for (var m in order) {
                            if (typeof order[m] != 'object') {
                                continue;
                            }
                            for (var p in order[m]) {
                                if (typeof order[m][p] != 'object') {
                                    continue;
                                }
                                orderTbody.innerHTML += '<tr>'
                                + '<td>' + m
                                + '<\/td><td>' + p
                                + '<\/td><td>' + order[m][p].quantity
                                + '<\/td><td>' + order[m][p].subtotal
                                + '<\/td>'
                                + '<\/tr>';
                            }
                        }
                        orderTable.appendChild(orderTbody);
                        //console.log(orderTable);
                        div.appendChild(orderTable);
                        //console.log(div);
                    }
                }
            }
        }
    </script>
    <style>
        @import url("https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css");
        @import url("https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css");
        td:nth-of-type(1) {
            width: 6em;
        }
        td:nth-of-type(2) {
            width: 15em;
        }
        td:nth-of-type(3) {
            width: 2em;
        }
        td:nth-of-type(4) {
            width: 2em;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="h2" id="title">
            「蘭不住你」付款區
        </div>
        <div class="input-group mb-2 search">
            <div class="input-group-prepend">
                <span class="input-group-text">學號</span>
            </div><input class="form-control" disabled id="search" placeholder="學號" type="text">
            <div class="input-group-append" id="btn-search">
                <button class="btn btn-outline-primary" id="searchBtn" type="button">輸入</button>
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="input-group mb-2 total">
            <div class="input-group-prepend">
                <span class="input-group-text">金額</span>
            </div><input class="form-control" disabled id="total" placeholder="金額" type="text">
            <div class="input-group-append" id="btn-total">
                <button class="btn btn-outline-primary" disabled id="resetBtn" type="button">重設</button>
            </div>
        </div>
        <div class="input-group mb-2 paid">
            <div class="input-group-prepend">
                <span class="input-group-text">收您</span>
            </div><input aria-describedby="btn-paid" class="form-control" disabled id="paid" placeholder="實收金額" type="text">
            <div class="input-group-append" id="btn-paid">
                <button class="btn btn-outline-primary" disabled id="checkout" type="button">找零</button>
            </div>
        </div>
        <div class="input-group mb-2 change">
            <div class="input-group-prepend">
                <span class="input-group-text">找零</span>
            </div><input aria-describedby="btn-change" class="form-control" disabled id="change" placeholder="找零" type="text">
            <div class="input-group-append" id="btn-change">
                <button class="btn btn-outline-primary" disabled id="sumbit" type="button">確認</button>
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="mb-2" id="message">
            <div>
                共有&nbsp;<span id="countText">0</span>&nbsp;筆尚未付款的結果
            </div>
        </div>
        <div class="" id="result"></div>
    </div>
</body>
</html>